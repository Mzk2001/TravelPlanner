# 旅游助手Web应用 - 技术设计文档

## 1. 系统架构设计

### 1.1 整体架构
```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   前端 (React)   │    │  后端 (Spring Boot) │    │   第三方服务     │
│                 │    │                 │    │                 │
│ - 用户界面      │◄──►│ - REST API      │◄──►│ - 科大讯飞API   │
│ - 地图组件      │    │ - 业务逻辑      │    │ - 高德地图API   │
│ - 语音识别      │    │ - 数据访问      │    │ - 通义千问API   │
│ - 状态管理      │    │ - 认证授权      │    │                 │
└─────────────────┘    └─────────────────┘    └─────────────────┘
                                │
                                ▼
                       ┌─────────────────┐
                       │   数据存储       │
                       │                 │
                       │ - PostgreSQL    │
                       └─────────────────┘
```

### 1.2 技术栈选择理由

**前端技术栈：**
- **React 18 + TypeScript：** 提供类型安全，组件化开发，生态丰富
- **Ant Design：** 企业级UI组件库，开箱即用，设计规范
- **Vite：** 快速构建工具，开发体验好
- **Redux Toolkit：** 状态管理，支持异步操作

**后端技术栈：**
- **Spring Boot 3.x：** 您熟悉的框架，生态成熟，开发效率高
- **PostgreSQL：** 关系型数据库，支持JSON字段，适合复杂查询
- **JWT：** 无状态认证，适合前后端分离

## 2. 数据库设计

### 2.1 核心表结构

#### 用户表 (users)
```sql
CREATE TABLE users (
    id BIGSERIAL PRIMARY KEY,
    username VARCHAR(50) UNIQUE NOT NULL,
    email VARCHAR(100) UNIQUE NOT NULL,
    password_hash VARCHAR(255) NOT NULL,
    avatar_url VARCHAR(500),
    preferences JSONB,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### 行程表 (trips)
```sql
CREATE TABLE trips (
    id BIGSERIAL PRIMARY KEY,
    user_id BIGINT REFERENCES users(id) ON DELETE CASCADE,
    title VARCHAR(200) NOT NULL,
    destination VARCHAR(100) NOT NULL,
    start_date DATE NOT NULL,
    end_date DATE NOT NULL,
    budget DECIMAL(10,2),
    travelers_count INTEGER DEFAULT 1,
    preferences JSONB,
    status VARCHAR(20) DEFAULT 'draft',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### 行程详情表 (trip_details)
```sql
CREATE TABLE trip_details (
    id BIGSERIAL PRIMARY KEY,
    trip_id BIGINT REFERENCES trips(id) ON DELETE CASCADE,
    day_number INTEGER NOT NULL,
    date DATE NOT NULL,
    activities JSONB NOT NULL,
    accommodation JSONB,
    transportation JSONB,
    meals JSONB,
    notes TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### 费用记录表 (expenses)
```sql
CREATE TABLE expenses (
    id BIGSERIAL PRIMARY KEY,
    trip_id BIGINT REFERENCES trips(id) ON DELETE CASCADE,
    category VARCHAR(50) NOT NULL,
    amount DECIMAL(10,2) NOT NULL,
    currency VARCHAR(3) DEFAULT 'CNY',
    description TEXT,
    date DATE NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

### 2.2 索引设计
```sql
-- 用户表索引
CREATE INDEX idx_users_email ON users(email);
CREATE INDEX idx_users_username ON users(username);

-- 行程表索引
CREATE INDEX idx_trips_user_id ON trips(user_id);
CREATE INDEX idx_trips_dates ON trips(start_date, end_date);
CREATE INDEX idx_trips_status ON trips(status);

-- 行程详情表索引
CREATE INDEX idx_trip_details_trip_id ON trip_details(trip_id);
CREATE INDEX idx_trip_details_date ON trip_details(date);

-- 费用记录表索引
CREATE INDEX idx_expenses_trip_id ON expenses(trip_id);
CREATE INDEX idx_expenses_date ON expenses(date);
CREATE INDEX idx_expenses_category ON expenses(category);
```

## 3. API设计

### 3.1 RESTful API规范

#### 基础URL
```
https://api.travelplanner.com/v1
```

#### 统一响应格式
```json
{
    "code": 200,
    "message": "success",
    "data": {},
    "timestamp": "2024-01-01T00:00:00Z"
}
```

### 3.2 核心API接口

#### 用户认证相关
```http
POST /auth/register
POST /auth/login
POST /auth/logout
POST /auth/refresh
GET  /auth/profile
PUT  /auth/profile
```

#### 行程管理相关
```http
GET    /trips                    # 获取用户行程列表
POST   /trips                    # 创建新行程
GET    /trips/{id}               # 获取行程详情
PUT    /trips/{id}               # 更新行程
DELETE /trips/{id}               # 删除行程
POST   /trips/{id}/plan          # AI生成行程规划
```

#### 费用管理相关
```http
GET    /trips/{id}/expenses      # 获取费用记录
POST   /trips/{id}/expenses      # 添加费用记录
PUT    /expenses/{id}            # 更新费用记录
DELETE /expenses/{id}            # 删除费用记录
GET    /trips/{id}/budget        # 获取预算分析
```

#### 语音和AI相关
```http
POST   /ai/speech-to-text        # 语音转文字
POST   /ai/generate-plan         # AI生成行程
POST   /ai/optimize-budget       # AI预算优化
```

### 3.3 API详细设计

#### 创建行程
```http
POST /trips
Content-Type: application/json
Authorization: Bearer {token}

{
    "title": "日本东京5日游",
    "destination": "东京",
    "startDate": "2024-03-01",
    "endDate": "2024-03-05",
    "budget": 10000.00,
    "travelersCount": 2,
    "preferences": {
        "interests": ["美食", "动漫", "文化"],
        "accommodation": "酒店",
        "transportation": "飞机"
    }
}
```

#### AI生成行程规划
```http
POST /trips/{id}/plan
Content-Type: application/json
Authorization: Bearer {token}

{
    "requirements": "我想去日本，5天，预算1万元，喜欢美食和动漫，带孩子"
}
```

## 4. 前端架构设计

### 4.1 组件结构
```
src/
├── components/           # 通用组件
│   ├── Map/             # 地图组件
│   ├── VoiceInput/      # 语音输入组件
│   ├── TripCard/        # 行程卡片组件
│   └── ExpenseChart/    # 费用图表组件
├── pages/               # 页面组件
│   ├── Home/            # 首页
│   ├── TripPlan/        # 行程规划页
│   ├── TripDetail/      # 行程详情页
│   ├── Profile/         # 用户中心
│   └── Settings/        # 设置页面
├── services/            # API服务
│   ├── api.ts           # API客户端
│   ├── auth.ts          # 认证服务
│   └── trip.ts          # 行程服务
├── store/               # 状态管理
│   ├── authSlice.ts     # 认证状态
│   ├── tripSlice.ts     # 行程状态
│   └── store.ts         # Store配置
└── utils/               # 工具函数
    ├── constants.ts     # 常量定义
    ├── helpers.ts       # 辅助函数
    └── validators.ts    # 验证函数
```

### 4.2 状态管理设计
```typescript
// store/authSlice.ts
interface AuthState {
    user: User | null;
    token: string | null;
    isAuthenticated: boolean;
    loading: boolean;
}

// store/tripSlice.ts
interface TripState {
    trips: Trip[];
    currentTrip: Trip | null;
    loading: boolean;
    error: string | null;
}
```

## 5. 后端架构设计

### 5.1 包结构
```
src/main/java/com/travelplanner/
├── TravelPlannerApplication.java
├── config/              # 配置类
│   ├── SecurityConfig.java
│   └── DatabaseConfig.java
├── controller/          # 控制器
│   ├── AuthController.java
│   ├── TripController.java
│   └── ExpenseController.java
├── service/             # 业务逻辑
│   ├── AuthService.java
│   ├── TripService.java
│   ├── AIService.java
│   └── ExpenseService.java
├── repository/          # 数据访问
│   ├── UserRepository.java
│   ├── TripRepository.java
│   └── ExpenseRepository.java
├── entity/              # 实体类
│   ├── User.java
│   ├── Trip.java
│   └── Expense.java
├── dto/                 # 数据传输对象
│   ├── LoginRequest.java
│   ├── TripCreateRequest.java
│   └── TripResponse.java
├── security/            # 安全相关
│   ├── JwtUtil.java
│   └── JwtAuthenticationFilter.java
└── util/                # 工具类
    ├── ApiResponse.java
    └── Constants.java
```

### 5.2 核心服务设计

#### AI服务 (AIService)
```java
@Service
public class AIService {
    
    @Autowired
    private QwenService qwenService;
    
    @Autowired
    private AmapService amapService;
    
    public TripPlan generateTripPlan(TripPlanRequest request) {
        // 1. 调用通义千问API生成行程规划
        // 2. 调用高德地图API获取地理位置信息
        // 3. 整合数据返回完整行程计划
    }
    
    public String speechToText(MultipartFile audioFile) {
        // 调用科大讯飞API进行语音识别
    }
}
```

#### 行程服务 (TripService)
```java
@Service
@Transactional
public class TripService {
    
    @Autowired
    private TripRepository tripRepository;
    
    @Autowired
    private AIService aiService;
    
    public Trip createTrip(Long userId, TripCreateRequest request) {
        // 创建行程记录
    }
    
    public TripPlan generatePlan(Long tripId, String requirements) {
        // 调用AI服务生成行程规划
    }
}
```

## 6. 第三方服务集成

### 6.1 科大讯飞语音识别
```java
@Component
public class XunfeiSpeechService {
    
    private static final String API_URL = "https://iat-api.xfyun.cn/v2/iat";
    
    public String recognizeSpeech(MultipartFile audioFile) {
        // 实现语音识别逻辑
    }
}
```

### 6.2 高德地图服务
```java
@Component
public class AmapService {
    
    @Value("${amap.api.key}")
    private String apiKey;
    
    public List<POI> searchPOI(String keyword, String city) {
        // 搜索兴趣点
    }
    
    public Route calculateRoute(Location origin, Location destination) {
        // 计算路线
    }
}
```

### 6.3 通义千问服务
```java
@Component
public class QwenService {
    
    @Value("${qwen.api.key}")
    private String apiKey;
    
    @Value("${qwen.api.url}")
    private String apiUrl;
    
    public String generateTripPlan(String requirements) {
        // 调用通义千问API生成行程规划
        // 使用阿里云DashScope API
    }
    
    public String optimizeBudget(String tripInfo, String requirements) {
        // 调用通义千问API优化预算建议
    }
}
```

## 7. 安全设计

### 7.1 认证授权
- JWT Token认证
- 密码BCrypt加密
- API接口权限控制
- CORS跨域配置

### 7.2 数据安全
- API密钥环境变量存储
- 敏感数据加密传输
- SQL注入防护
- XSS攻击防护

## 8. 部署设计

### 8.1 Docker配置
```dockerfile
# Dockerfile
FROM openjdk:17-jdk-slim
COPY target/travelplanner-*.jar app.jar
EXPOSE 8080
ENTRYPOINT ["java", "-jar", "/app.jar"]
```

### 8.2 GitHub Actions配置
```yaml
# .github/workflows/docker-build.yml
name: Build and Push Docker Image
on:
  push:
    branches: [main]
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Build Docker image
        run: docker build -t travelplanner .
      - name: Push to Aliyun
        run: docker push registry.cn-hangzhou.aliyuncs.com/your-namespace/travelplanner
```

## 9. 开发计划

### 9.1 第一阶段（1-2周）
- 项目初始化和环境搭建
- 用户认证系统
- 基础数据库设计
- 简单的行程CRUD功能

### 9.2 第二阶段（2-3周）
- AI服务集成
- 语音识别功能
- 地图服务集成
- 前端界面开发

### 9.3 第三阶段（1周）
- 费用管理功能
- 系统测试和优化
- Docker部署配置
- 文档完善

## 10. 技术难点和解决方案

### 10.1 AI服务集成
**难点：** 通义千问API调用稳定性和成本控制
**解决方案：** 
- 实现重试机制和熔断器
- 设置API调用频率限制
- 使用阿里云DashScope的流式响应

### 10.2 语音识别准确性
**难点：** 中文语音识别准确率
**解决方案：**
- 选择专业的中文语音识别服务
- 实现语音预处理和降噪
- 提供文本编辑功能作为备选

### 10.3 地图服务集成
**难点：** 地图数据准确性和实时性
**解决方案：**
- 使用高德地图API获取准确数据
- 实现数据缓存机制
- 提供离线地图功能

## 11. 性能优化策略

### 11.1 数据库优化
- 合理设计索引
- 使用连接池
- 实现读写分离

### 11.2 缓存策略
- 数据库查询结果缓存
- 前端缓存静态资源
- API响应缓存

### 11.3 前端优化
- 代码分割和懒加载
- 图片压缩和CDN
- 组件复用和优化
