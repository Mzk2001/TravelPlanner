<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>控制台调试 - 字段提取测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .test-section h3 {
            margin-top: 0;
            color: #1890ff;
        }
        button {
            background: #1890ff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #40a9ff;
        }
        .console-output {
            background: #f0f0f0;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 10px;
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .status.success {
            background: #f6ffed;
            border: 1px solid #b7eb8f;
            color: #52c41a;
        }
        .status.error {
            background: #fff2f0;
            border: 1px solid #ffccc7;
            color: #ff4d4f;
        }
        .status.info {
            background: #e6f7ff;
            border: 1px solid #91d5ff;
            color: #1890ff;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔍 字段提取调试工具</h1>
        <p>这个页面用于测试字段提取功能，检查提取的字段是否正确传输到前端。</p>
        
        <div class="test-section">
            <h3>📋 测试步骤</h3>
            <ol>
                <li>打开浏览器开发者工具 (F12)</li>
                <li>切换到 Console 标签页</li>
                <li>点击下面的测试按钮</li>
                <li>观察控制台输出，查看字段提取的详细信息</li>
            </ol>
        </div>

        <div class="test-section">
            <h3>🧪 API 测试</h3>
            <button onclick="testSendMessage()">发送测试消息</button>
            <button onclick="testGetConversations()">获取对话历史</button>
            <button onclick="clearConsole()">清空控制台</button>
            
            <div id="status" class="status info" style="display: none;">
                准备测试...
            </div>
            
            <div class="console-output" id="console-output">
                控制台输出将显示在这里...
            </div>
        </div>

        <div class="test-section">
            <h3>📝 测试消息</h3>
            <p>使用以下消息进行测试：</p>
            <ul>
                <li><strong>简单测试：</strong> "我想去日本东京旅游"</li>
                <li><strong>完整测试：</strong> "我想去日本东京旅游，预算1万元，2个人，喜欢美食和动漫"</li>
                <li><strong>复杂测试：</strong> "计划去法国巴黎旅行，预算2万人民币，3个人，喜欢艺术和美食，时间是明年春天"</li>
            </ul>
        </div>

        <div class="test-section">
            <h3>🔍 检查要点</h3>
            <ul>
                <li>✅ API响应中是否包含 <code>extractedFields</code></li>
                <li>✅ <code>extractedFields</code> 是否包含正确的字段值</li>
                <li>✅ 前端是否正确接收和显示这些字段</li>
                <li>✅ 字段类型是否正确 (destination, budget, groupSize, travelType)</li>
            </ul>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8080/api';
        
        // 模拟用户登录获取token
        let authToken = null;
        
        async function login() {
            try {
                const response = await fetch(`${API_BASE}/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        username: 'test',
                        password: 'test123'
                    })
                });
                
                const data = await response.json();
                if (data.token) {
                    authToken = data.token;
                    console.log('✅ 登录成功，获取到token:', authToken);
                    showStatus('登录成功', 'success');
                    return true;
                } else {
                    console.error('❌ 登录失败:', data);
                    showStatus('登录失败: ' + (data.message || '未知错误'), 'error');
                    return false;
                }
            } catch (error) {
                console.error('❌ 登录请求失败:', error);
                showStatus('登录请求失败: ' + error.message, 'error');
                return false;
            }
        }
        
        async function testSendMessage() {
            console.log('🚀 开始测试发送消息...');
            showStatus('正在测试发送消息...', 'info');
            
            // 先登录
            const loginSuccess = await login();
            if (!loginSuccess) {
                return;
            }
            
            try {
                const testMessage = "我想去日本东京旅游，预算1万元，2个人，喜欢美食和动漫";
                console.log('📤 发送测试消息:', testMessage);
                
                const response = await fetch(`${API_BASE}/conversations/chat`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({
                        userId: 1,
                        message: testMessage
                    })
                });
                
                const data = await response.json();
                console.log('📥 收到响应:', data);
                
                // 详细检查extractedFields
                if (data.extractedFields) {
                    console.log('✅ 找到extractedFields:', data.extractedFields);
                    console.log('🔍 字段详情:', {
                        destination: data.extractedFields.destination,
                        budget: data.extractedFields.budget,
                        groupSize: data.extractedFields.groupSize,
                        travelType: data.extractedFields.travelType,
                        hasAllFields: !!(data.extractedFields.destination && data.extractedFields.budget && data.extractedFields.groupSize && data.extractedFields.travelType)
                    });
                    showStatus('✅ 消息发送成功，字段提取正常', 'success');
                } else {
                    console.log('❌ 未找到extractedFields');
                    showStatus('❌ 消息发送成功，但未提取到字段', 'error');
                }
                
            } catch (error) {
                console.error('❌ 发送消息失败:', error);
                showStatus('发送消息失败: ' + error.message, 'error');
            }
        }
        
        async function testGetConversations() {
            console.log('🚀 开始测试获取对话历史...');
            showStatus('正在测试获取对话历史...', 'info');
            
            // 先登录
            const loginSuccess = await login();
            if (!loginSuccess) {
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/conversations?userId=1&page=0&size=10`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                const data = await response.json();
                console.log('📥 获取对话历史响应:', data);
                
                if (data.content && data.content.length > 0) {
                    console.log('📋 对话列表:', data.content);
                    
                    // 检查每个对话的extractedFields
                    data.content.forEach((conv, index) => {
                        console.log(`💬 对话 ${index + 1}:`, {
                            id: conv.id,
                            userMessage: conv.userMessage,
                            aiResponse: conv.aiResponse?.substring(0, 100) + '...',
                            extractedFields: conv.extractedFields,
                            hasExtractedFields: !!conv.extractedFields
                        });
                        
                        if (conv.extractedFields) {
                            console.log(`✅ 对话 ${index + 1} 有extractedFields:`, conv.extractedFields);
                        } else {
                            console.log(`❌ 对话 ${index + 1} 没有extractedFields`);
                        }
                    });
                    
                    const conversationsWithFields = data.content.filter(conv => conv.extractedFields);
                    showStatus(`✅ 获取到 ${data.content.length} 条对话，其中 ${conversationsWithFields.length} 条包含提取字段`, 'success');
                } else {
                    console.log('📭 没有找到对话记录');
                    showStatus('📭 没有找到对话记录', 'info');
                }
                
            } catch (error) {
                console.error('❌ 获取对话历史失败:', error);
                showStatus('获取对话历史失败: ' + error.message, 'error');
            }
        }
        
        function clearConsole() {
            console.clear();
            document.getElementById('console-output').innerHTML = '控制台已清空...';
            showStatus('控制台已清空', 'info');
        }
        
        function showStatus(message, type) {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = message;
            statusDiv.className = `status ${type}`;
            statusDiv.style.display = 'block';
        }
        
        // 页面加载完成后的初始化
        window.addEventListener('load', function() {
            console.log('🔍 字段提取调试工具已加载');
            console.log('📋 请按照以下步骤进行测试:');
            console.log('1. 确保后端服务运行在 http://localhost:8080');
            console.log('2. 点击"发送测试消息"按钮');
            console.log('3. 观察控制台输出中的extractedFields信息');
            console.log('4. 点击"获取对话历史"按钮检查已保存的字段');
            
            showStatus('调试工具已准备就绪', 'info');
        });
    </script>
</body>
</html>
