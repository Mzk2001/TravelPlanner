<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ§åˆ¶å°è°ƒè¯• - å­—æ®µæå–æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .test-section h3 {
            margin-top: 0;
            color: #1890ff;
        }
        button {
            background: #1890ff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #40a9ff;
        }
        .console-output {
            background: #f0f0f0;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 10px;
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .status.success {
            background: #f6ffed;
            border: 1px solid #b7eb8f;
            color: #52c41a;
        }
        .status.error {
            background: #fff2f0;
            border: 1px solid #ffccc7;
            color: #ff4d4f;
        }
        .status.info {
            background: #e6f7ff;
            border: 1px solid #91d5ff;
            color: #1890ff;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” å­—æ®µæå–è°ƒè¯•å·¥å…·</h1>
        <p>è¿™ä¸ªé¡µé¢ç”¨äºæµ‹è¯•å­—æ®µæå–åŠŸèƒ½ï¼Œæ£€æŸ¥æå–çš„å­—æ®µæ˜¯å¦æ­£ç¡®ä¼ è¾“åˆ°å‰ç«¯ã€‚</p>
        
        <div class="test-section">
            <h3>ğŸ“‹ æµ‹è¯•æ­¥éª¤</h3>
            <ol>
                <li>æ‰“å¼€æµè§ˆå™¨å¼€å‘è€…å·¥å…· (F12)</li>
                <li>åˆ‡æ¢åˆ° Console æ ‡ç­¾é¡µ</li>
                <li>ç‚¹å‡»ä¸‹é¢çš„æµ‹è¯•æŒ‰é’®</li>
                <li>è§‚å¯Ÿæ§åˆ¶å°è¾“å‡ºï¼ŒæŸ¥çœ‹å­—æ®µæå–çš„è¯¦ç»†ä¿¡æ¯</li>
            </ol>
        </div>

        <div class="test-section">
            <h3>ğŸ§ª API æµ‹è¯•</h3>
            <button onclick="testSendMessage()">å‘é€æµ‹è¯•æ¶ˆæ¯</button>
            <button onclick="testGetConversations()">è·å–å¯¹è¯å†å²</button>
            <button onclick="clearConsole()">æ¸…ç©ºæ§åˆ¶å°</button>
            
            <div id="status" class="status info" style="display: none;">
                å‡†å¤‡æµ‹è¯•...
            </div>
            
            <div class="console-output" id="console-output">
                æ§åˆ¶å°è¾“å‡ºå°†æ˜¾ç¤ºåœ¨è¿™é‡Œ...
            </div>
        </div>

        <div class="test-section">
            <h3>ğŸ“ æµ‹è¯•æ¶ˆæ¯</h3>
            <p>ä½¿ç”¨ä»¥ä¸‹æ¶ˆæ¯è¿›è¡Œæµ‹è¯•ï¼š</p>
            <ul>
                <li><strong>ç®€å•æµ‹è¯•ï¼š</strong> "æˆ‘æƒ³å»æ—¥æœ¬ä¸œäº¬æ—…æ¸¸"</li>
                <li><strong>å®Œæ•´æµ‹è¯•ï¼š</strong> "æˆ‘æƒ³å»æ—¥æœ¬ä¸œäº¬æ—…æ¸¸ï¼Œé¢„ç®—1ä¸‡å…ƒï¼Œ2ä¸ªäººï¼Œå–œæ¬¢ç¾é£Ÿå’ŒåŠ¨æ¼«"</li>
                <li><strong>å¤æ‚æµ‹è¯•ï¼š</strong> "è®¡åˆ’å»æ³•å›½å·´é»æ—…è¡Œï¼Œé¢„ç®—2ä¸‡äººæ°‘å¸ï¼Œ3ä¸ªäººï¼Œå–œæ¬¢è‰ºæœ¯å’Œç¾é£Ÿï¼Œæ—¶é—´æ˜¯æ˜å¹´æ˜¥å¤©"</li>
            </ul>
        </div>

        <div class="test-section">
            <h3>ğŸ” æ£€æŸ¥è¦ç‚¹</h3>
            <ul>
                <li>âœ… APIå“åº”ä¸­æ˜¯å¦åŒ…å« <code>extractedFields</code></li>
                <li>âœ… <code>extractedFields</code> æ˜¯å¦åŒ…å«æ­£ç¡®çš„å­—æ®µå€¼</li>
                <li>âœ… å‰ç«¯æ˜¯å¦æ­£ç¡®æ¥æ”¶å’Œæ˜¾ç¤ºè¿™äº›å­—æ®µ</li>
                <li>âœ… å­—æ®µç±»å‹æ˜¯å¦æ­£ç¡® (destination, budget, groupSize, travelType)</li>
            </ul>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8080/api';
        
        // æ¨¡æ‹Ÿç”¨æˆ·ç™»å½•è·å–token
        let authToken = null;
        
        async function login() {
            try {
                const response = await fetch(`${API_BASE}/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        username: 'test',
                        password: 'test123'
                    })
                });
                
                const data = await response.json();
                if (data.token) {
                    authToken = data.token;
                    console.log('âœ… ç™»å½•æˆåŠŸï¼Œè·å–åˆ°token:', authToken);
                    showStatus('ç™»å½•æˆåŠŸ', 'success');
                    return true;
                } else {
                    console.error('âŒ ç™»å½•å¤±è´¥:', data);
                    showStatus('ç™»å½•å¤±è´¥: ' + (data.message || 'æœªçŸ¥é”™è¯¯'), 'error');
                    return false;
                }
            } catch (error) {
                console.error('âŒ ç™»å½•è¯·æ±‚å¤±è´¥:', error);
                showStatus('ç™»å½•è¯·æ±‚å¤±è´¥: ' + error.message, 'error');
                return false;
            }
        }
        
        async function testSendMessage() {
            console.log('ğŸš€ å¼€å§‹æµ‹è¯•å‘é€æ¶ˆæ¯...');
            showStatus('æ­£åœ¨æµ‹è¯•å‘é€æ¶ˆæ¯...', 'info');
            
            // å…ˆç™»å½•
            const loginSuccess = await login();
            if (!loginSuccess) {
                return;
            }
            
            try {
                const testMessage = "æˆ‘æƒ³å»æ—¥æœ¬ä¸œäº¬æ—…æ¸¸ï¼Œé¢„ç®—1ä¸‡å…ƒï¼Œ2ä¸ªäººï¼Œå–œæ¬¢ç¾é£Ÿå’ŒåŠ¨æ¼«";
                console.log('ğŸ“¤ å‘é€æµ‹è¯•æ¶ˆæ¯:', testMessage);
                
                const response = await fetch(`${API_BASE}/conversations/chat`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({
                        userId: 1,
                        message: testMessage
                    })
                });
                
                const data = await response.json();
                console.log('ğŸ“¥ æ”¶åˆ°å“åº”:', data);
                
                // è¯¦ç»†æ£€æŸ¥extractedFields
                if (data.extractedFields) {
                    console.log('âœ… æ‰¾åˆ°extractedFields:', data.extractedFields);
                    console.log('ğŸ” å­—æ®µè¯¦æƒ…:', {
                        destination: data.extractedFields.destination,
                        budget: data.extractedFields.budget,
                        groupSize: data.extractedFields.groupSize,
                        travelType: data.extractedFields.travelType,
                        hasAllFields: !!(data.extractedFields.destination && data.extractedFields.budget && data.extractedFields.groupSize && data.extractedFields.travelType)
                    });
                    showStatus('âœ… æ¶ˆæ¯å‘é€æˆåŠŸï¼Œå­—æ®µæå–æ­£å¸¸', 'success');
                } else {
                    console.log('âŒ æœªæ‰¾åˆ°extractedFields');
                    showStatus('âŒ æ¶ˆæ¯å‘é€æˆåŠŸï¼Œä½†æœªæå–åˆ°å­—æ®µ', 'error');
                }
                
            } catch (error) {
                console.error('âŒ å‘é€æ¶ˆæ¯å¤±è´¥:', error);
                showStatus('å‘é€æ¶ˆæ¯å¤±è´¥: ' + error.message, 'error');
            }
        }
        
        async function testGetConversations() {
            console.log('ğŸš€ å¼€å§‹æµ‹è¯•è·å–å¯¹è¯å†å²...');
            showStatus('æ­£åœ¨æµ‹è¯•è·å–å¯¹è¯å†å²...', 'info');
            
            // å…ˆç™»å½•
            const loginSuccess = await login();
            if (!loginSuccess) {
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/conversations?userId=1&page=0&size=10`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                const data = await response.json();
                console.log('ğŸ“¥ è·å–å¯¹è¯å†å²å“åº”:', data);
                
                if (data.content && data.content.length > 0) {
                    console.log('ğŸ“‹ å¯¹è¯åˆ—è¡¨:', data.content);
                    
                    // æ£€æŸ¥æ¯ä¸ªå¯¹è¯çš„extractedFields
                    data.content.forEach((conv, index) => {
                        console.log(`ğŸ’¬ å¯¹è¯ ${index + 1}:`, {
                            id: conv.id,
                            userMessage: conv.userMessage,
                            aiResponse: conv.aiResponse?.substring(0, 100) + '...',
                            extractedFields: conv.extractedFields,
                            hasExtractedFields: !!conv.extractedFields
                        });
                        
                        if (conv.extractedFields) {
                            console.log(`âœ… å¯¹è¯ ${index + 1} æœ‰extractedFields:`, conv.extractedFields);
                        } else {
                            console.log(`âŒ å¯¹è¯ ${index + 1} æ²¡æœ‰extractedFields`);
                        }
                    });
                    
                    const conversationsWithFields = data.content.filter(conv => conv.extractedFields);
                    showStatus(`âœ… è·å–åˆ° ${data.content.length} æ¡å¯¹è¯ï¼Œå…¶ä¸­ ${conversationsWithFields.length} æ¡åŒ…å«æå–å­—æ®µ`, 'success');
                } else {
                    console.log('ğŸ“­ æ²¡æœ‰æ‰¾åˆ°å¯¹è¯è®°å½•');
                    showStatus('ğŸ“­ æ²¡æœ‰æ‰¾åˆ°å¯¹è¯è®°å½•', 'info');
                }
                
            } catch (error) {
                console.error('âŒ è·å–å¯¹è¯å†å²å¤±è´¥:', error);
                showStatus('è·å–å¯¹è¯å†å²å¤±è´¥: ' + error.message, 'error');
            }
        }
        
        function clearConsole() {
            console.clear();
            document.getElementById('console-output').innerHTML = 'æ§åˆ¶å°å·²æ¸…ç©º...';
            showStatus('æ§åˆ¶å°å·²æ¸…ç©º', 'info');
        }
        
        function showStatus(message, type) {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = message;
            statusDiv.className = `status ${type}`;
            statusDiv.style.display = 'block';
        }
        
        // é¡µé¢åŠ è½½å®Œæˆåçš„åˆå§‹åŒ–
        window.addEventListener('load', function() {
            console.log('ğŸ” å­—æ®µæå–è°ƒè¯•å·¥å…·å·²åŠ è½½');
            console.log('ğŸ“‹ è¯·æŒ‰ç…§ä»¥ä¸‹æ­¥éª¤è¿›è¡Œæµ‹è¯•:');
            console.log('1. ç¡®ä¿åç«¯æœåŠ¡è¿è¡Œåœ¨ http://localhost:8080');
            console.log('2. ç‚¹å‡»"å‘é€æµ‹è¯•æ¶ˆæ¯"æŒ‰é’®');
            console.log('3. è§‚å¯Ÿæ§åˆ¶å°è¾“å‡ºä¸­çš„extractedFieldsä¿¡æ¯');
            console.log('4. ç‚¹å‡»"è·å–å¯¹è¯å†å²"æŒ‰é’®æ£€æŸ¥å·²ä¿å­˜çš„å­—æ®µ');
            
            showStatus('è°ƒè¯•å·¥å…·å·²å‡†å¤‡å°±ç»ª', 'info');
        });
    </script>
</body>
</html>
